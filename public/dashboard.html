<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Centro de Mando | AidFlow Ninja</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body class="bg-ninja">

    <div id="loadingScreen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; align-items:center; justify-content:center;">
        <h2 class="shogun-title-mini blinking">SINCRONIZANDO CICLO...</h2>
    </div>

    <div class="dashboard-grid">
        
        <aside class="sidebar">
            <div class="profile-summary" style="text-align:center; margin-bottom:30px;">
                <div style="position:relative; width:80px; height:80px; margin:0 auto 10px;">
                    <img id="sideAvatar" src="images/ninja-avatar.png" style="width:100%; border-radius:50%; border:2px solid var(--gold);">
                    <div id="sideLevelBadge" style="position:absolute; bottom:0; right:0; background:#333; color:#fff; padding:2px 6px; font-size:10px; border-radius:4px; border:1px solid #555;">RONIN</div>
                </div>
                <h3 id="sideName" class="gold-text">...</h3>
                <p id="sideStatus" class="muted-text" style="font-size:11px;">Esperando Pase</p>
            </div>

            <nav>
                <button onclick="showSection('resumen')" class="sidebar-btn active">üìä MI CICLO</button>
                <button onclick="showSection('perfil')" class="sidebar-btn">üë§ PERFIL & RETIROS</button>
                <div style="height:1px; background:#333; margin:10px 0;"></div>
                <button onclick="showSection('training')" class="sidebar-btn">üßò PR√ÅCTICA (GRATIS)</button>
                <button onclick="showSection('arena')" id="navArena" class="sidebar-btn locked">‚öîÔ∏è ARENA & TORNEOS üîí</button>
                <div style="height:1px; background:#333; margin:10px 0;"></div>
                <button onclick="showSection('dao')" id="navDao" class="sidebar-btn locked">‚öñÔ∏è DAO (Nivel 3) üîí</button>
                <button id="logoutBtn" class="sidebar-btn" style="color:var(--blood); margin-top:20px;">üö™ SALIR</button>
            </nav>
        </aside>

        <main class="main-content">
            
            <header class="flex-between" style="margin-bottom:30px;">
                <h2 id="sectionTitle" class="shogun-title-mini">ESTADO DEL CICLO</h2>

               <div class="clan-stats flex-between" style="background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333;">
    
    <div class="stat-item" style="text-align: center;">
        <span class="muted-text" style="font-size: 10px; display: block;">FONDO DAO</span>
        <strong id="globalDao" class="gold-text" style="font-size: 16px;">--</strong>
    </div>

    <div class="stat-item" style="text-align: center; border-left: 1px solid #444; padding-left: 20px;">
        <span class="muted-text" style="font-size: 10px; display: block;">POZO PREMIOS</span>
        <strong id="globalPrizes" class="red-text" style="font-size: 16px;">--</strong>
    </div>

    <div class="stat-item" style="text-align: center; border-left: 1px solid #444; padding-left: 20px;">
        <span class="muted-text" style="font-size: 10px; display: block;">MIS REFERIDOS</span>
        <div style="display:flex; align-items:center; gap:5px; justify-content:center;">
            <strong id="myReferrals" style="color: #fff; font-size: 16px;">0</strong>
            <button onclick="copyReferralLink()" title="Copiar Link de Reclutamiento" style="background:none; border:none; cursor:pointer; color:var(--gold);">üîó</button>
        </div>
        <div style="font-size: 10px; color: #0f0;">+<span id="referralEarnings">0</span> NC</div>
    </div>

</div>

    <div class="stat-item" style="text-align: center;">
        <span class="muted-text" style="font-size: 10px; display: block;">FONDO DAO (COMUNIDAD)</span>
        <strong id="globalDao" class="gold-text" style="font-size: 16px;">Cargando...</strong>
    </div>

    <div class="stat-item" style="text-align: center; border-left: 1px solid #444; padding-left: 20px;">
        <span class="muted-text" style="font-size: 10px; display: block;">POZO DE TORNEOS</span>
        <strong id="globalPrizes" class="red-text" style="font-size: 16px;">Cargando...</strong>
    </div>

    <div class="stat-item" style="text-align: center; border-left: 1px solid #444; padding-left: 20px;">
        <span class="muted-text" style="font-size: 10px; display: block;">MIS REFERIDOS</span>
        <strong id="myReferrals" style="color: #fff; font-size: 16px;">0 Guerreros</strong>
        <div style="font-size: 10px; color: #0f0;">+<span id="referralEarnings">0</span> NC Ganados</div>
    </div>

</div>
                
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="balance-pill" style="background:#111; padding:5px 15px; border:1px solid var(--gold); border-radius:20px; display: flex; align-items: center; gap: 10px;">
                        <span>üí∞ BOLSA: <span id="headerBalance" class="gold-text">0.00</span> USD</span>
                        <button onclick="document.getElementById('modalDeposito').style.display='flex'" class="btn-ninja-primary" style="font-size: 10px; padding: 4px 10px; border-radius: 4px;">
                            + RECARGAR
                        </button>
                    </div>
                </div>
            </header>

            <section id="missionSection" class="card-ninja" style="margin-bottom: 20px; border: 1px dashed #d90429; padding: 15px; background: rgba(20,20,20,0.8);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 class="gold-text" style="font-size: 14px; margin-bottom: 5px; margin-top:0;">üìú MISI√ìN DIARIA</h3>
                        <p class="muted-text" style="font-size: 12px; margin:0;">Objetivo: Check-in T√°ctico</p>
                    </div>
                    <div class="reward-badge" style="background: var(--ninja-red); color:white; padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 12px;">
                        +$0.20 USD
                    </div>
                </div>

                <div class="mission-status" style="margin-top: 15px;">
                    <button id="missionBtn" class="btn-ninja-primary full-width" style="display: flex; justify-content: center; align-items: center; gap: 10px; width:100%;">
                        <span>‚öîÔ∏è RECLAMAR RECOMPENSA</span>
                    </button>
                    <p id="missionTimer" class="muted-text text-center" style="margin-top: 10px; font-size: 11px; display: none; text-align:center;">
                        Pr√≥xima misi√≥n disponible en: <span id="countdown">--:--</span>
                    </p>
                </div>
            </section>
            
            <div id="promoBanner" class="ninja-pass-banner" style="display:none;">
                <div>
                    <h3 class="gold-text">‚ö†Ô∏è MODO RONIN (GRATUITO)</h3>
                    <p style="font-size:12px; color:#ccc;">Activa tu Pase Ninja para entrar al Ciclo de Retenci√≥n y generar ingresos.</p>
                </div>
                <button onclick="openLevelModal()" class="btn-ninja-primary">FORJAR PASE</button>
            </div>

            <section id="sec-resumen" class="content-section">
                
                <div id="cycleContainer" class="card-dark" style="display:none;">
                    <div class="flex-between">
                        <span>üåÄ PROGRESO DEL CICLO ACTUAL</span>
                        <span id="cyclePercentText" class="gold-text">0%</span>
                    </div>

                    <div class="cycle-track-container">
                        <div class="track-bg">
                            <div id="trackFill" class="track-fill"></div>
                        </div>
                        
                        <div id="cp25" class="checkpoint cp-25">‚úì</div>
                        <div id="cp50" class="checkpoint cp-50">‚úì</div>
                        <div id="cp75" class="checkpoint cp-75">‚úì</div>
                        <div id="cp100" class="checkpoint cp-100">‚òÖ</div>
                    </div>

                    <div class="track-labels">
                        <span>INICIO</span>
                        <span id="lbl25">25%</span>
                        <span id="lbl50">50%</span>
                        <span id="lbl75">75%</span>
                        <span id="lbl100">100%</span>
                    </div>

                    <div style="margin-top:25px; background: rgba(0,0,0,0.3); padding:15px; border-radius:4px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <p style="font-size:12px; color:#888; margin-bottom:5px;">DISPONIBLE PARA RETIRO:</p>
                            <h2 id="withdrawableAmount" style="margin:0; color:#fff;">$0.00 USD</h2>
                        </div>
                        <button id="btnRetiro" onclick="procesarRetiro()" class="btn-ninja-outline" disabled>
                            BLOQUEADO üîí
                        </button>
                    </div>
                </div>

                <div class="card-dark" style="margin-top:20px;">
                    <h3>üí¨ DOJO GLOBAL</h3>
                    <div id="chatBox" style="height:150px; background:#000; overflow-y:auto; padding:10px; margin-bottom:10px; border:1px solid #333;"></div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="chatInput" placeholder="Habla..." style="flex:1; background:#111; color:white; border:1px solid #333; padding:10px;">
                        <button class="btn-ninja-primary">ENVIAR</button>
                    </div>
                </div>
            </section>

            <section id="sec-training" class="content-section" style="display:none;">
                <h3>üßò JUEGOS DE PR√ÅCTICA</h3><div id="embedGamesGrid" class="grid-ninja"></div>
            </section>
            
            <section id="sec-arena" class="content-section" style="display:none;">
                <h3>‚öîÔ∏è ARENA DE TORNEOS</h3><div id="tournamentsGrid"></div>
            </section>

             <section id="sec-dao" class="content-section" style="display:none;">
                <h2 class="gold-text">‚öñÔ∏è CONSEJO DAO (Nivel 3)</h2>
                <p>Tu inversi√≥n de $40 te otorga voz y voto en el futuro del clan.</p>
            </section>
        </main>
    </div>

    <div id="levelModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:#0d0d0d; border:2px solid var(--gold); padding:30px; width:90%; max-width:500px; position:relative;">
            <button onclick="closeLevelModal()" style="position:absolute; top:10px; right:10px; background:none; border:none; color:white; cursor:pointer;">X</button>
            <h2 class="shogun-title-mini" style="text-align:center; margin-bottom:20px;">FORJAR PASE NINJA</h2>
            <div class="level-card" onclick="selectLevel(1)">
                <div><h3 style="color:#fff; margin:0;">NIVEL 1: INICIADO</h3><small style="color:#888;">Costo $10</small></div>
                <span class="price-tag">$10</span>
            </div>
            <div class="level-card" onclick="selectLevel(2)">
                <div><h3 style="color:var(--gold); margin:0;">NIVEL 2: GUERRERO</h3><small style="color:#888;">Costo $20</small></div>
                <span class="price-tag">$20</span>
            </div>
            <div class="level-card" onclick="selectLevel(3)">
                <div><h3 style="color:var(--blood); margin:0;">NIVEL 3: SENSEI</h3><small style="color:#888;">Costo $40</small></div>
                <span class="price-tag">$40</span>
            </div>
        </div>
    </div>

    <div id="gameModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:3000; flex-direction:column; align-items:center; justify-content:center;">
        <div style="width:90%; max-width:1000px; display:flex; justify-content:flex-end; margin-bottom:10px;">
            <button onclick="closeGame()" class="btn-ninja-outline" style="background:#000; color:white;">CERRAR JUEGO X</button>
        </div>
        <div style="width:90%; max-width:1000px; height:80vh; border:2px solid var(--gold); box-shadow: 0 0 30px rgba(255,180,0,0.2);">
            <iframe id="gameFrame" src="" style="width:100%; height:100%; border:none; background:#000;"></iframe>
        </div>
    </div>

    <div id="modalDeposito" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:4000; align-items:center; justify-content:center;">
        <div class="card-ninja" style="max-width:450px; width:90%; position:relative; border: 2px solid var(--gold);">
            
            <button onclick="document.getElementById('modalDeposito').style.display='none'" style="position:absolute; top:10px; right:10px; background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            
            <h2 class="gold-text text-center" style="margin-bottom:10px;">TESORER√çA DEL CLAN</h2>

            <div style="background: rgba(217, 4, 41, 0.15); border-left: 4px solid red; padding: 12px; margin-bottom: 20px; font-size: 0.85rem; color: #ddd; line-height: 1.4;">
                <strong style="color: #ff4757; display:block; margin-bottom:5px;">‚ö†Ô∏è REGLAS DE SEGURIDAD (ANTI-BAN)</strong>
                Al hacer la transferencia en Mercado Pago, en el campo <strong>"Motivo"</strong> o <strong>"Mensaje"</strong> escribe <u>SOLAMENTE</u>:
                <div id="depositUserHint" style="text-align:center; font-size: 1.2rem; font-weight:bold; color:white; margin:10px 0; background:#000; padding:5px; border-radius:4px;">
                    TU NOMBRE DE NINJA
                </div>
                üö´ <strong>PROHIBIDO USAR:</strong> "Pago", "Inversi√≥n", "AidFlow", "Cripto", "Torneo". <br>
                <small>*Si usas esas palabras, el pago ser√° rechazado.*</small>
            </div>

            <div style="text-align:center; margin-bottom:20px;">
                <p class="muted-text">Env√≠a tu tributo al Alias:</p>
                <div onclick="navigator.clipboard.writeText('DOJO.MASTER.MP'); alert('Alias copiado');" style="background:#222; padding:15px; border:1px dashed var(--gold); color:white; font-size:1.3rem; font-weight:bold; cursor:pointer; margin-top:5px;">
                    DOJO.MASTER.MP üìã
                </div>
                <p style="font-size:10px; color:#666; margin-top:5px;">(Toca para copiar)</p>
            </div>

            <form id="formDeposito">
                <label style="font-size:0.8rem; color:#888;">Monto Enviado (NC)</label>
                <input type="number" id="depMonto" placeholder="Ej: 1000" style="width:100%; padding:10px; margin-bottom:10px; background:#111; border:1px solid #333; color:white;" required>
                
                <label style="font-size:0.8rem; color:#888;">N¬∞ de Operaci√≥n (Comprobante MP)</label>
                <input type="text" id="depRef" placeholder="Ej: 1234567890" style="width:100%; padding:10px; margin-bottom:20px; background:#111; border:1px solid #333; color:white;" required>
                
                <button type="submit" class="btn-ninja-primary" style="width:100%;">ENVIAR COMPROBANTE üì§</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="module" src="js/dashboard.js"></script>
    
    <script>
        import { API_URL } from './js/api.js';

        // Poner el nombre del usuario en el modal para que no se olvide
        document.addEventListener("DOMContentLoaded", () => {
            const ninjaName = localStorage.getItem("ninjaName");
            if(ninjaName) {
                document.getElementById('depositUserHint').innerText = ninjaName;
            }
        });

        document.getElementById('formDeposito').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = document.getElementById('depMonto').value;
            const referenceId = document.getElementById('depRef').value;
            const token = localStorage.getItem('token');

            if(!amount || !referenceId) return alert("Completa todos los datos");

            try {
                // Usamos la API_URL definida en js/api.js si es posible, o hardcoded fallback
                // Nota: Al ser script inline, el import arriba podr√≠a fallar si no es module.
                // Mejor usamos fetch directo a la ruta relativa o localhost si estamos dev
                const baseUrl = "http://localhost:5000"; 

                const res = await fetch(`${baseUrl}/api/payments/deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ amount, referenceId })
                });

                const data = await res.json();
                if(res.ok) {
                    alert("‚úÖ " + data.message);
                    document.getElementById('modalDeposito').style.display = 'none';
                    document.getElementById('formDeposito').reset();
                } else {
                    alert("‚ö†Ô∏è " + data.message);
                }
            } catch(err) {
                alert("Error de conexi√≥n con el Templo.");
            }
        });
    </script>
</body>
</html>